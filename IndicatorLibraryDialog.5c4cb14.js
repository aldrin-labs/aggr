var t=Object.defineProperty,e=(e,i,a)=>(((e,i,a)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[i]=a})(e,"symbol"!=typeof i?i+"":i,a),a);import{n as i,C as a,V as s,x as n,u as r,y as o,w as l,d as c,z as d,A as p,B as u,k as m,L as h,_ as v,D as g,E as w,F as b,G as _,H as f,I as y,J as C,K as I,M as P,N as x,O as k,h as D,a as E}from"./index.5c4cb14.js";import{m as T}from"./marked.esm.5c4cb14.js";import{T as O,a as j}from"./Tab.5c4cb14.js";const $=i({props:{value:{type:String,default:""}}},(function(){var t=this,e=t._self._c;return e("div",{staticClass:"search-bar form-control"},[e("input",{directives:[{name:"autofocus",rawName:"v-autofocus"}],staticClass:"search-bar__input form-control w-100",attrs:{type:"text",placeholder:"Search"},domProps:{value:t.value},on:{input:function(e){return t.$emit("input",e.currentTarget.value)}}}),t._t("default")],2)}),[],!1,null,"da6a250e",null,null).exports;var L=Object.defineProperty,U=Object.getOwnPropertyDescriptor;const A=300,B=100;let S=class extends s{constructor(){super(...arguments),e(this,"previewCanvasElement"),e(this,"previewImageElement"),e(this,"previewObjectUrl"),e(this,"currentPreviewId"),e(this,"previewCtx")}mounted(){this.mountPreview()}beforeDestroy(){document.getElementById("app").removeChild(this.previewCanvasElement)}mountPreview(){const t=window.devicePixelRatio||1;this.previewCanvasElement=document.createElement("canvas"),this.previewCanvasElement.width=A*t,this.previewCanvasElement.height=B*t,this.previewCanvasElement.style.width=`${A}px`,this.previewCanvasElement.style.height=`${B}px`,this.previewCanvasElement.style.top="-1rem",this.previewCanvasElement.style.left="0",this.previewCanvasElement.style.position="absolute",this.previewCanvasElement.style.pointerEvents="none",this.previewCanvasElement.style.zIndex="11",this.previewCanvasElement.style.borderRadius="0.75rem",document.getElementById("app").appendChild(this.previewCanvasElement),this.previewCtx=this.previewCanvasElement.getContext("2d")}async showPreview(t){n()||(t.preview||(t.imagePath&&(t.preview=await fetch(`https://lib.aggr.trade/${t.imagePath}`).then((e=>{if(!e.ok)throw t.imagePath=null,new Error("Network response was not ok");return e.blob()}))),t.preview)?t.id!==this.currentPreviewId&&(this.clearPreview(),this.currentPreviewId=t.id,t.preview instanceof Blob&&(this.previewObjectUrl=URL.createObjectURL(t.preview),this.previewImageElement=new Image,this.previewImageElement.src=this.previewObjectUrl,this.previewImageElement.addEventListener("load",this.onLoad))):this.clearPreview())}onLoad(){const{width:t,height:e}=this.previewImageElement,i=window.devicePixelRatio||1;this.previewCtx.drawImage(this.previewImageElement,t-A*i,0,A*i,e,0,0,A*i,B*i),URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null,this.previewImageElement=null}movePreview(t){if(!this.previewCanvasElement)return;const e=r(t);this.previewCanvasElement.style.transform=`translate(${e.x-A/2}px, ${e.y-B}px)`}clearPreview(){this.previewCtx.clearRect(0,0,this.previewCanvasElement.width,this.previewCanvasElement.height),this.currentPreviewId=null,this.previewImageElement&&(this.previewImageElement.removeEventListener("load",this.onLoad),this.previewImageElement.src="",this.previewImageElement=null),this.previewObjectUrl&&(URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null)}};S=((t,e,i,a)=>{for(var s,n=a>1?void 0:a?U(e,i):e,r=t.length-1;r>=0;r--)(s=t[r])&&(n=(a?s(e,i,n):s(n))||n);return a&&n&&L(e,i,n),n})([a],S);const N=i({name:"IndicatorTable",mixins:[S],props:{indicators:{type:Array,required:!0},query:{type:String,default:""},showDropdown:{type:Boolean,default:!1},showAuthor:{type:Boolean,default:!1},showEnabled:{type:Boolean,default:!1}},data:()=>({ago:o,sortDirection:-1,sortProperty:"updatedAt"}),computed:{queryFilter(){return new RegExp(this.query.replace(/\W/,".*"),"i")},sortFunction(){return"description"===this.sortProperty?this.sortDirection>0?(t,e)=>(t.description||"").localeCompare(e.description||""):(t,e)=>(e.description||"").localeCompare(t.description||""):"name"===this.sortProperty?this.sortDirection>0?(t,e)=>(t.name||"").localeCompare(e.name||""):(t,e)=>(e.name||"").localeCompare(t.name||""):"createdAt"===this.sortProperty?this.sortDirection>0?(t,e)=>t.createdAt-e.createdAt:(t,e)=>e.createdAt-t.createdAt:"updatedAt"===this.sortProperty?this.sortDirection>0?(t,e)=>t.updatedAt-e.updatedAt:(t,e)=>e.updatedAt-t.updatedAt:"author"===this.sortProperty?this.sortDirection>0?(t,e)=>t.author-e.author:(t,e)=>e.author-t.author:(t,e)=>t.id.localeCompare(e.id)},filteredIndicators(){const t=this.sortFunction;return this.indicators.filter((t=>this.queryFilter.test(t.description)||this.queryFilter.test(t.name))).sort(t)}},methods:{toggleSort(t){t===this.sortProperty&&(this.sortDirection=-1*this.sortDirection),this.sortProperty=t}}},(function(){var t=this,e=t._self._c;return e("table",{staticClass:"table indicator-table__table"},[e("thead",[e("tr",[t.showEnabled?e("th",{staticClass:"table-min"}):t._e(),e("th",{staticClass:"table-sortable table-min",class:["name"===t.sortProperty&&"table-sort--active"],on:{click:function(e){return t.toggleSort("name")}}},[e("span",[t._v("Name")]),"name"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),e("th",{staticClass:"table-sortable w-100",on:{click:function(e){return t.toggleSort("description")}}},[e("span",[t._v("Description")]),"description"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showAuthor?e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(e){return t.toggleSort("author")}}},[e("span",[t._v("Author")]),"author"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]):t._e(),e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(e){return t.toggleSort("updatedAt")}}},[e("span",[t._v("Date")]),"updatedAt"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showDropdown?e("th",{staticClass:"table-min"}):t._e()])]),t.filteredIndicators.length?e("tbody",{on:{mousemove:t.movePreview,mouseleave:t.clearPreview}},t._l(t.filteredIndicators,(function(i){return e("tr",{key:i.id,staticClass:"-action",on:{click:function(e){return t.$emit("selected",i)},mouseenter:function(e){return t.showPreview(i)}}},[t.showEnabled?e("td",{staticClass:"table-action table-min",on:{click:function(e){return e.stopPropagation(),t.$emit("enabled",i)}}},[e("i",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"top"},expression:"{ placement: 'top' }"}],staticClass:"-lower",class:i.enabled?"icon-star-filled":"icon-star",attrs:{title:"Enable by default<br>on new charts"}})]):t._e(),e("td",{staticClass:"table-input text-color-base table-ellipsis",staticStyle:{"max-width":"200px"}},[t._v(" "+t._s((i.displayName||i.name).replace(/\{[\w_]+\}/g,""))+" ")]),e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(i.description))])]),t.showAuthor?e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(i.author))])]):t._e(),e("td",{staticClass:"-dialog-min-m table-input table-min text-right"},[e("span",[t._v(t._s(t.ago(i.updatedAt)))])]),t.showDropdown?e("td",{staticClass:"table-action -hover table-min",on:{click:function(e){return e.stopPropagation(),t.$emit("dropdown",[e,i])}}},[t._m(0,!0)]):t._e()])})),0):t._e()])}),[function(){var t=this._self._c;return t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-more"})])}],!1,null,"a17c4c26",null,null).exports;const R=i({name:"InstalledIndicators",components:{IndicatorTable:N,SearchBar:$},data:()=>({indicators:[],query:"",selectedIndicator:null,dropdownTrigger:null}),async created(){await this.getIndicators()},methods:{async getIndicators(){const t=+new Date("2021-06-07T00:00:00Z");await this.$nextTick(),this.indicators=(await l.getIndicators()).map((e=>({...e,enabled:void 0!==e.enabled&&e.enabled,updatedAt:e.updatedAt||t})))},async removeIndicator(t=this.selectedIndicator){await c.confirm({message:`Delete indicator "${t.name}"Â ?<br><br><code class="-filled"><small>#${t.id}</small></code>`,html:!0})&&(l.deleteIndicator(t.id),this.indicators.splice(this.indicators.indexOf(t),1))},async selectIndicator(t=this.selectedIndicator){this.$emit("add",t)},async duplicateIndicator(t=this.selectedIndicator){d.importIndicator({type:"indicator",name:t.name,data:t},{addToChart:!0})},async downloadIndicator(t=this.selectedIndicator){await p({type:"indicator",name:t.name,data:t},"indicator_"+t.id)},toggleDropdown([t,e]){!t||this.dropdownTrigger&&this.selectedIndicator===e?(this.dropdownTrigger=null,this.selectedIndicator=null):(this.dropdownTrigger=t.currentTarget,this.selectedIndicator=e)},toggleEnabled(t){t.enabled=!t.enabled,l.saveIndicator(t,!0)}}},(function(){var t=this,e=t._self._c;return e("div",{staticClass:"installed-indicators"},[e("SearchBar",{model:{value:t.query,callback:function(e){t.query=e},expression:"query"}}),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-enabled":"","show-dropdown":""},on:{selected:function(e){return t.$emit("selected",e)},enabled:t.toggleEnabled,dropdown:t.toggleDropdown}}),e("dropdown",{model:{value:t.dropdownTrigger,callback:function(e){t.dropdownTrigger=e},expression:"dropdownTrigger"}},[e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.selectIndicator()}}},[e("i",{staticClass:"icon-plus"}),e("span",[t._v("Add to chart")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.duplicateIndicator()}}},[e("i",{staticClass:"icon-copy-paste"}),e("span",[t._v("Duplicate")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.downloadIndicator()}}},[e("i",{staticClass:"icon-download"}),e("span",[t._v("Download")])]),e("div",{staticClass:"dropdown-divider"}),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.removeIndicator()}}},[e("i",{staticClass:"icon-trash"}),e("span",[t._v("Remove")])])])],1)}),[],!1,null,"f04bb70c",null,null).exports;const F=i({name:"CommunityIndicatorsIncentive",components:{Btn:u},data:()=>({isDismissed:m.hasDismissed("community-indicators-incentive"),repoUrl:"https://github.com/Tucsky/aggr-lib"}),methods:{dismiss(){m.dismiss("community-indicators-incentive"),this.isDismissed=!0}}},(function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators-incentive",class:[t.isDismissed&&"community-indicators-incentive--dismissed"]},[e("div",{staticClass:"community-indicators-incentive__wrapper"},[e("div",{staticClass:"community-indicators-incentive__head"},[e("h3",{staticClass:"community-indicators-incentive__title"},[t._v(" Introducing Aggr Library ")]),t.isDismissed?t._e():e("Btn",{staticClass:"community-indicators-incentive__close -small -text",on:{click:t.dismiss}},[e("i",{staticClass:"icon-cross"})])],1),e("p",{staticClass:"community-indicators-incentive__subtitle"},[t._v(" Indicators that are uploaded to "),e("a",{attrs:{href:t.repoUrl,target:"_blank"}},[t._v("aggr-lib")]),t._v(" will automatically appear in this list. ")]),e("Btn",{staticClass:"community-indicators-incentive__cta -theme",attrs:{href:t.repoUrl,target:"_blank"}},[e("i",{staticClass:"icon-github mr8"}),t._v(" Start contributing ")])],1)])}),[],!1,null,"44ee81c3",null,null).exports;let q=[];const V=i({name:"CommunityIndicators",components:{SearchBar:$,IndicatorTable:N,LibraryIncentive:F,Loader:h,Btn:u},data:()=>({indicators:q,query:"",selectedIndicator:null,dropdownTrigger:null,isLoading:!1}),async created(){q.length||await this.getIndicators()},methods:{async getIndicators(){this.isLoading=!0;try{q=await(await fetch("https://lib.aggr.trade/library/indicators")).json(),this.indicators=q}catch(t){this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicators"})}finally{this.isLoading=!1}}}},(function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators"},[t.isLoading?e("Loader",{staticClass:"community-indicators__loader"}):t._e(),e("transition",{attrs:{name:"transition-height-scale"}},[t.isLoading?t._e():e("div",{staticClass:"community-indicators__wrapper"},[e("LibraryIncentive"),e("SearchBar",{staticClass:"community-indicators__search-bar",model:{value:t.query,callback:function(e){t.query=e},expression:"query"}},[e("Btn",{staticClass:"-text -small",on:{click:t.getIndicators}},[e("i",{staticClass:"icon-refresh"})])],1),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-author":""},on:{selected:function(e){return t.$emit("selected",e)}}})],1)])],1)}),[],!1,null,"26d8a1e7",null,null).exports;const M=i({name:"EditResourceDialog",components:{Btn:u,MarkdownEditor:()=>v((()=>import("./MarkdownEditor.5c4cb14.js")),["MarkdownEditor.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","marked.esm.5c4cb14.js","MarkdownEditor.5c4cb14.css"])},props:{item:{type:Object,required:!0},ids:{type:Array,required:!0}},mixins:[g],data(){return{dialogOpened:!1,name:this.item.name||"",description:this.item.description||"",updateId:!1,imageObjectUrl:null,newImagePreview:null,hasDeletedPreview:!1}},computed:{displayId(){const t=this.item.id;return t?t.length<=16?t:t.slice(0,6)+".."+t.substr(-6):"no id"},newId(){return w(b(this.name),this.idsExceptCurrent)},idsExceptCurrent(){return this.ids.filter((t=>t!==this.item.id))},hasCustomPreview(){return!this.hasDeletedPreview&&!!(this.newImagePreview||this.item.preview instanceof File)},previewName(){return this.hasCustomPreview?this.item.id+".png":"Browse"}},mounted(){this.loadPreview(),this.show()},beforeDestroy(){this.clearPreview()},methods:{show(){this.dialogOpened=!0},hide(){this.dialogOpened=!1},onHide(){this.close()},submit(){this.output={...this.item,name:this.name,displayName:this.name,description:this.description},this.newImagePreview?this.output.preview=this.newImagePreview:this.hasDeletedPreview&&(this.output.preview=null),this.updateId&&(this.output.id=this.newId),this.hide()},loadPreview(){this.clearPreview();const t=this.newImagePreview||this.item.preview;(t instanceof File||t instanceof Blob)&&(this.imageObjectUrl=URL.createObjectURL(t))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},handlePreviewFile(){const t=event.target.files[0];t&&(this.newImagePreview=t,this.hasDeletedPreview=!1,this.loadPreview())},removePreview(){this.newImagePreview&&(this.newImagePreview=null),this.clearPreview(),this.hasDeletedPreview=!0},resizeEditor(){this.$refs.editor&&this.$refs.editor.resize()}}},(function(){var t=this,e=t._self._c;return e("form",{on:{submit:function(e){return e.preventDefault(),t.submit.apply(null,arguments)}}},[e("transition",{attrs:{name:"dialog",duration:500},on:{"after-leave":t.onHide}},[t.dialogOpened?e("Dialog",{staticClass:"edit-resource-dialog",on:{clickOutside:t.hide,resize:t.resizeEditor},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title"},[t._v("Edit "+t._s(t.item.name))]),e("small",{staticClass:"-center"},[e("code",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"-filled -center ml4",attrs:{title:`ID: ${t.item.id}`}},[t._v(" "+t._s(t.displayId)+" ")])])])]},proxy:!0},{key:"footer",fn:function(){return[e("Btn",{staticClass:"btn -text",attrs:{type:"button"},on:{click:t.hide}},[t._v("Cancel")]),e("Btn",{staticClass:"btn -green ml8 -large",attrs:{type:"submit"}},[e("i",{staticClass:"icon-check mr8"}),t._v(" Save ")])]},proxy:!0}],null,!1,2469990179)},[e("div",{staticClass:"d-flex -gap16 mb16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Name")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.name,expression:"name"}],staticClass:"form-control w-100",attrs:{id:"label",type:"text",required:""},domProps:{value:t.name},on:{input:function(e){e.target.composing||(t.name=e.target.value)}}})]),t.item.name!==t.name?e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Â ")]),e("label",{staticClass:"checkbox-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.updateId,expression:"updateId"}],staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t.updateId)?t._i(t.updateId,null)>-1:t.updateId},on:{change:function(e){var i=t.updateId,a=e.target,s=!!a.checked;if(Array.isArray(i)){var n=t._i(i,null);a.checked?n<0&&(t.updateId=i.concat([null])):n>-1&&(t.updateId=i.slice(0,n).concat(i.slice(n+1)))}else t.updateId=s}}}),e("div",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"mr8",attrs:{title:"Get a new ID"}}),e("i",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info",attrs:{title:"IDs are unique in the library !"}})])]):t._e()]),t.updateId&&t.item.id!==t.newId?e("p",[e("i",{staticClass:"icon-info"}),t._v(" ID change "),e("code",{staticClass:"-filled"},[t._v(t._s(t.item.id))]),t._v(" â "),e("code",{staticClass:"-filled"},[t._v(t._s(t.newId))])]):t._e(),e("div",{staticClass:"form-group mb16 flex-grow-1 d-flex -column"},[e("label",{attrs:{for:"label"}},[t._v(" Description "),e("span",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info",attrs:{title:'Markdown supported <span class="badge -red ml4">new</span>'}})]),e("MarkdownEditor",{ref:"editor",staticClass:"w-100 flex-grow-1",staticStyle:{height:"auto"},attrs:{minimal:""},model:{value:t.description,callback:function(e){t.description=e},expression:"description"}})],1),e("div",{staticClass:"d-flex -gap16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Preview")]),e("button",{staticClass:"btn -file -blue -cases"},[e("i",{staticClass:"icon-upload mr8"}),t._v(" "+t._s(t.previewName)+" "),t.hasCustomPreview?e("i",{staticClass:"icon-cross mr8 btn__suffix",on:{click:function(e){return e.stopPropagation(),e.preventDefault(),t.removePreview.apply(null,arguments)}}}):t._e(),e("input",{staticClass:"input-file",attrs:{type:"file",accept:"image/*"},on:{change:t.handlePreviewFile}})])]),e("div",{staticClass:"edit-resource-dialog__preview"},[t.imageObjectUrl?e("img",{attrs:{src:t.imageObjectUrl}}):t._e()])])]):t._e()],1)],1)}),[],!1,null,"89928202",null,null).exports;function Z(t={}){const e=["priceScaleId","strokeWidth","scaleMargins","priceFormat","crosshairMarkerVisible","lastValueVisible","priceLineVisible","baseLineVisible","type","minMove","precision","priceLineStyle","color","lineWidth","lineStyle","lineType","priceLineColor","borderVisible","upColor","downColor","borderUpColor","borderDownColor","wickUpColor","wickDownColor","topFillColor1","topFillColor2","topLineColor","bottomFillColor1","bottomFillColor2","bottomLineColor","lineWidth","color","topColor","bottomColor","lineColor","lineStyle","lineWidth","positiveColor","negativeColor","positiveLineColor","higherLineStyle","higherLineWidth","negativeLineColor","lowerLineStyle","lowerLineWidth","color","thinBars","upColor","downColor","openVisible"];return Object.keys(t).filter((t=>e.includes(t))).reduce(((e,i)=>(e[i]=t[i],e)),{})}async function W(t){if(!t.preview)return void c.confirm({cancel:!1,message:"Indicator's preview is mandatory for publishing. Just save it once it's added on a chart to generate the thumbnail !"});let e=localStorage.getItem("author");if(!e){if(e=await c.prompt({action:"Name yourself",label:"Username"}),!e)return;localStorage.setItem("author",e)}const i={...t,options:Z(t.options),preview:void 0,author:e},a=new FormData;try{const e=new Blob([JSON.stringify(i)],{type:"application/json"});a.append("jsonFile",e,"indicator.json"),a.append("pngFile",t.preview,"indicator.png")}catch(n){throw new Error("Failed to create payload")}const s=await fetch("https://lib.aggr.trade/publish/indicators",{method:"POST",body:a});if(!s.ok)throw new Error("Failed to publish");try{const{url:t}=await s.json();return t}catch(n){throw new Error("Failed to parse server response")}}const z=i({props:{id:{type:String,default:null},path:{default:null},preview:{default:null},isInstalled:{type:Boolean,default:!1}},components:{Btn:u},data:()=>({imageDimensions:{width:0,height:0},imagePosition:{x:0,y:0},isImageZoomed:!1,imageObjectUrl:null}),computed:{source(){return this.preview||this.path},image(){return this.imageObjectUrl?this.imageObjectUrl:this.path?`https://lib.aggr.trade/${this.path}`:null}},watch:{source:{immediate:!0,handler(){this.loadPreview()}}},beforeDestroy(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},methods:{loadPreview(){this.clearPreview();const t=this.preview;(t instanceof Blob||t instanceof File)&&(this.imageObjectUrl=URL.createObjectURL(t))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},onImageLoad(t){const e=t.target,i=window.devicePixelRatio||1;if(this.imageDimensions={height:e.naturalHeight/i,width:e.naturalWidth/i},this.imageDimensions.width<this.$el.clientWidth){const t=this.imageDimensions.height/this.imageDimensions.width;this.imageDimensions.width=this.$el.clientWidth,this.imageDimensions.height=this.$el.clientWidth*t}e.style.width=this.imageDimensions.width+"px",e.style.height=this.imageDimensions.height+"px",this.centerImage()},centerImage(){const t=this.$refs.preview,e=this.$refs.image;if(!e)return;const i=t.getBoundingClientRect(),a=e.getBoundingClientRect(),s=(i.width-a.width)/2,n=(i.height-a.height)/2;this.imagePosition.x=s,this.imagePosition.y=n,e.style.transform=`translate(${s}px, ${n}px)`},scheduleImageZoom(t){this.isImageZoomed||(this._imageZoomTimeout&&clearTimeout(this._imageZoomTimeout),this._imageZoomTimeout=setTimeout((async()=>{this._imageZoomTimeout=null,this.isImageZoomed=!0,await this.$nextTick(),this.moveImage(t)}),1e3))},moveImage(t){const e=this.$refs.preview,i=this.$refs.image;if(!i)return;const a=e.getBoundingClientRect(),s=i.getBoundingClientRect();this.isImageZoomed&&(a.height=this.imageDimensions.height,s.height=this.imageDimensions.height);const n=Math.max(0,s.width-a.width),r=Math.max(0,s.height-a.height),o=t.clientX-a.left,l=t.clientY-a.top,c=o/a.width*n,d=l/a.height*r,p=Math.min(Math.max(-c,-n),0),u=Math.min(Math.max(-d,-r),0);this.imagePosition.x=p,this.imagePosition.y=u,i.style.transform=`translate(${p}px, ${u}px)`,this.scheduleImageZoom(t)},resetImage(){this.isImageZoomed=!1,this.centerImage(),this._imageZoomTimeout&&(clearTimeout(this._imageZoomTimeout),this._imageZoomTimeout=null)}}},(function(){var t=this,e=t._self._c;return e("div",{ref:"preview",staticClass:"indicator-preview",class:[t.isImageZoomed&&"indicator-preview--zoomed"],style:{"--image-height":t.imageDimensions.height+"px"},on:{mousemove:t.moveImage,mouseleave:t.resetImage}},[t.id?[e("Btn",{staticClass:"indicator-preview__close -text",on:{click:function(e){return t.$emit("close")}}},[e("i",{staticClass:"icon-cross"})]),e("code",{staticClass:"indicator-preview__id -filled"},[e("small",[t._v("#"+t._s(t.id))])])]:t._e(),t.image?e("img",{ref:"image",attrs:{src:t.image},on:{load:t.onImageLoad}}):t._e()],2)}),[],!1,null,"9a0f8a88",null,null).exports;const H=i({mixins:[g],components:{InstalledIndicators:R,CommunityIndicators:V,IndicatorDetail:i(_({__name:"IndicatorDetail",props:{indicator:{type:Object,required:!0},paneId:{type:String,default:null}},emits:["add","reload","close"],setup(t,{emit:e}){const i=t,a=f(!1),s=f(!1),n=f(!1),r=f(!1),p=f(null),h=f(null),g=f(null),w=f(0),b=y("background-150",.5),_=C((()=>!!i.indicator.script)),D=C((()=>{const t=[];return i.indicator.updatedAt&&t.push({label:"Updated",value:`${o(i.indicator.updatedAt)} ago`}),i.indicator.createdAt&&t.push({label:"Created",value:`${o(i.indicator.createdAt)} ago`}),t})),E=C((()=>i.indicator.pr?i.indicator.pr.split("/").pop():null)),O=C((()=>`https://github.com/Tucsky/aggr-lib/tree/main/indicators/${i.indicator.author}`)),j=C((()=>{var t;const e=null==(t=I())?void 0:t.proxy.$store;return!(!i.paneId||!e.state[i.paneId].indicators)&&!!Object.values(e.state[i.paneId].indicators).find((t=>t.libraryId===i.indicator.id))})),$=C((()=>i.indicator.versions||g.value||[])),L=C((()=>i.indicator.description?T(i.indicator.description):_.value?"Add description":""));P((()=>i.indicator),(async()=>{s.value&&await B()}),{immediate:!0}),x((()=>{a.value=!0}));const U=()=>{a.value=!1},A=async()=>{if(!i.indicator.versions){r.value=!0,await k(1e3);try{const t=await fetch(`https://lib.aggr.trade/versions/${i.indicator.jsonPath}`);g.value=await t.json()}catch{g.value=[]}finally{r.value=!1}}},B=()=>{e("add",i.indicator)};return{__sfc:!0,props:i,emit:e,opened:a,isInstalling:s,isPublishing:n,isFetchingVersions:r,menuDropdownTrigger:p,versionsDropdownTrigger:h,fetchedVersions:g,dateIndex:w,communityTabEnabled:!0,footerColor:b,isInstalled:_,dates:D,prId:E,authorUrl:O,added:j,versions:$,description:L,close:U,toggleMenuDropdown:t=>{p.value=t&&!p.value?t.currentTarget:null},toggleVersionsDropdown:async t=>{t&&!h.value?(i.indicator.versions||g.value||await A(),h.value=t.target):h.value=null},onBackdropClick:t=>{t.target===t.currentTarget&&U()},fetchIndicatorVersions:A,installIndicator:async t=>{var e;if(!_.value){s.value=!0;try{const e=await async function(t,e,i){let a,s;if(i?(a=await(await fetch(`https://lib.aggr.trade/version/${i}/${t}`)).json(),s=await(await fetch(`https://lib.aggr.trade/version/${i}/${e}`)).blob()):(a=await(await fetch(`https://lib.aggr.trade/${t}`)).json(),s=await(await fetch(`https://lib.aggr.trade/${e}`)).blob()),!a.data)throw new Error("invalid payload");return a.data.preview=s,a}(i.indicator.jsonPath,i.indicator.imagePath,t);await d.importIndicator(e,{addToChart:!0})}catch(a){(null==(e=I())?void 0:e.proxy.$store).dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicator"})}finally{s.value=!1}}},addToChart:B,editName:async()=>{if(!_.value)return;const t=await c.prompt({label:"Name",action:"Rename",placeholder:i.indicator.name});t&&t!==i.indicator.name&&(await l.saveIndicator({...i.indicator,name:t,displayName:t},!0),e("reload"))},editDescription:async()=>{if(!_.value)return;const t=await c.prompt({label:"Description",action:"Edit",placeholder:i.indicator.description,input:i.indicator.description,markdown:!0},"edit-description");t&&t!==i.indicator.description&&(await l.saveIndicator({...i.indicator,description:t},!0),e("reload"))},publish:async()=>{var t;if(_.value)try{const t=await async function(t){if(m.hasDismissed("publish-onboarding")||await c.openAsPromise((await v((()=>import("./PublishOnboarding.5c4cb14.js")),["PublishOnboarding.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","PublishOnboarding.5c4cb14.css"])).default))return c.openAsPromise((await v((()=>import("./PublishResourceDialog.5c4cb14.js")),["PublishResourceDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","marked.esm.5c4cb14.js","Tab.5c4cb14.js","Tab.5c4cb14.css","PublishResourceDialog.5c4cb14.css"])).default,{item:t})}(i.indicator);t&&(await l.saveIndicator({...i.indicator,pr:t},!0),e("reload"))}catch(a){(null==(t=I())?void 0:t.proxy.$store).dispatch("app/showNotice",{type:"error",title:"Failed to publish indicator"})}},edit:async()=>{const t=await c.openAsPromise(M,{item:i.indicator,ids:await l.getIndicatorsIds()});t&&(t.id!==i.indicator.id&&await l.deleteIndicator(i.indicator.id),await l.saveIndicator(t,!0),e("reload",t.id))},Btn:u,IndicatorPreview:z}}}),(function(){var t=this,e=t._self._c,i=t._self._setupProxy;return e("transition",{attrs:{name:"indicator-detail"},on:{"after-leave":function(t){return i.emit("close")}}},[i.opened?e("div",{staticClass:"indicator-detail",on:{click:i.onBackdropClick}},[e("div",{staticClass:"indicator-detail__wrapper hide-scrollbar"},[e(i.IndicatorPreview,{staticClass:"indicator-detail__preview",attrs:{id:t.indicator.id,preview:t.indicator.preview,path:t.indicator.imagePath,"is-installed":i.isInstalled},on:{close:i.close}}),e("div",{staticClass:"indicator-detail__content"},[e("div",{staticClass:"indicator-detail__head"},[e("div",{staticClass:"indicator-detail__name"},[e("div",{on:{dblclick:i.editName}},[t._v(" "+t._s(t.indicator.displayName||t.indicator.name)+" ")]),i.isInstalled?e(i.Btn,{staticClass:"-text -small indicator-detail__toggle",on:{click:i.toggleMenuDropdown}},[e("i",{staticClass:"icon-more"})]):t._e()],1),e("small",{staticClass:"indicator-detail__subtitle"},[t.indicator.author?e("span",[t._v(" by "),e("a",{attrs:{href:i.authorUrl,target:"_blank"}},[t._v(t._s(t.indicator.author))])]):t._e(),e("span",{on:{click:function(t){i.dateIndex=(i.dateIndex+1)%i.dates.length}}},[t._v(" "+t._s(i.dates[i.dateIndex].label)+"Â "+t._s(i.dates[i.dateIndex].value)+" ")])])]),e("div",{staticClass:"indicator-detail__detail"},[e("div",{staticClass:"indicator-detail__description marked",domProps:{innerHTML:t._s(i.description)},on:{dblclick:i.editDescription}}),e("ul",{staticClass:"indicator-detail__metadatas"},[t.indicator.pr?e("li",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"right",distance:24},expression:"{ placement: 'right', distance: 24 }"}],attrs:{title:"Publish request"}},[e("span",[t._v("Publish")]),e("a",{staticClass:"indicator-detail__metadatas-value",attrs:{target:"_blank",href:t.indicator.pr}},[t._v(" #"+t._s(i.prId)+" ")])]):t._e()])])]),e("div",{staticClass:"indicator-detail__footer",style:{backgroundColor:i.footerColor}},[i.isInstalled?e(i.Btn,{on:{click:i.addToChart}},[e("i",{staticClass:"icon-plus mr4"}),t._v(" Add "+t._s(i.added?"again":"")+" ")]):e("div",{staticClass:"btn-group d-flex"},[e(i.Btn,{attrs:{loading:i.isInstalling,disabled:i.isInstalling||i.isFetchingVersions},on:{click:function(t){return i.installIndicator()}}},[t._v("Install")]),e(i.Btn,{class:[!i.isFetchingVersions&&"-arrow"],attrs:{loading:i.isFetchingVersions,disabled:i.isInstalling||i.isFetchingVersions},on:{click:i.toggleVersionsDropdown}})],1)],1),e("dropdown",{model:{value:i.menuDropdownTrigger,callback:function(t){i.menuDropdownTrigger=t},expression:"menuDropdownTrigger"}},[i.communityTabEnabled?e(i.Btn,{staticClass:"dropdown-item -cases",attrs:{loading:i.isPublishing},on:{click:i.publish}},[e("i",{staticClass:"icon-external-link-square-alt"}),e("span",[t._v("Publish")])]):t._e(),e(i.Btn,{staticClass:"dropdown-item -cases",on:{click:i.edit}},[e("i",{staticClass:"icon-edit"}),e("span",[t._v("Edit")])])],1),e("dropdown",{model:{value:i.versionsDropdownTrigger,callback:function(t){i.versionsDropdownTrigger=t},expression:"versionsDropdownTrigger"}},[!i.versions.length&&i.fetchedVersions?[e("div",{staticClass:"px8 text-danger"},[t._v("No history available")])]:t._l(i.versions,(function(a){return e(i.Btn,{key:a.sha,staticClass:"dropdown-item -cases",attrs:{loading:i.isPublishing},on:{click:function(t){return i.installIndicator(a.sha)}}},[t._v(" "+t._s(a.date)+" ")])}))],2)],1)]):t._e()])}),[],!1,null,"0be25cca",null,null).exports,TransitionHeight:D,Dialog:E,Tabs:O,Tab:j},data:()=>({name:"",tab:"installed",selection:null,communityTabEnabled:!0,ago:o}),computed:{isBack(){return"installed"===this.tab},paneId(){if(this.$store.state.app.focusedPaneId&&"chart"===this.$store.state.panes.panes[this.$store.state.app.focusedPaneId].type)return this.$store.state.app.focusedPaneId;for(const t in this.$store.state.panes.panes)if("chart"===this.$store.state.panes.panes[t].type)return t;return null}},methods:{async handleFile(t){try{const e=await d.getJSON(t.target.files[0]);await d.importIndicator(e,{save:!0,openLibrary:!0})}catch(e){this.$store.dispatch("app/showNotice",{title:e.message,type:"error"})}},showNoPaneId(){c.confirm({title:"No chart",message:"Add a chart to continue",cancel:null,ok:"Ok"})},async addToChart(t,e=!1){this.$store.dispatch(this.paneId+"/addIndicator",await l.incrementIndicatorUsage(t.id)),e&&this.close()},async createIndicator(t={}){if(!this.paneId)return this.showNoPaneId();t.name||(t.name="Untitled"),t.libraryId||(t.libraryId=null),c.openIndicator(this.paneId,await this.$store.dispatch(this.paneId+"/addIndicator",t)),this.close()},async promptCreateIndicator(){if(!this.paneId)return this.showNoPaneId();const t=await c.openAsPromise((await v((()=>import("./CreateIndicatorDialog.5c4cb14.js")),["CreateIndicatorDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","options.5c4cb14.js"])).default,{paneId:this.paneId});t&&this.createIndicator(t)},setSelection(t){this.selection=t,this.$refs.installed&&this.$refs.installed.getIndicators()},async reloadSelection(t){this.selection&&this.setSelection(await l.getIndicator(t||this.selection.id))}}},(function(){var t=this,e=t._self._c;return e("Dialog",{staticClass:"indicator-library-dialog",attrs:{size:"medium",contrasted:""},on:{clickOutside:t.close},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title indicator-dialog__title -center"},[e("div",[t._v("Indicators")])])])]},proxy:!0},{key:"subheader",fn:function(){return[e("tabs",{model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[e("tab",{attrs:{name:"installed"}},[t._v(" Installed ")]),t.communityTabEnabled?e("tab",{attrs:{name:"community"}},[t._v(" Community ")]):t._e()],1)]},proxy:!0},{key:"footer",fn:function(){return[e("button",{staticClass:"btn -theme -large -cases -file"},[e("input",{ref:"importButton",staticClass:"input-file",attrs:{type:"file"},on:{change:t.handleFile}}),t._v(" Import "),e("i",{staticClass:"icon-upload ml8"})]),e("button",{staticClass:"mlauto btn -green -large -cases",on:{click:t.promptCreateIndicator}},[t._v(" Create "),e("i",{staticClass:"icon-plus ml8"})])]},proxy:!0}])},[e("TransitionHeight",{staticClass:"indicator-library-dialog__stepper",attrs:{stepper:"",name:"slide-fade-"+(t.isBack?"left":"right"),duration:500}},["installed"===t.tab?e("InstalledIndicators",{key:"installed",ref:"installed",attrs:{"pane-id":t.paneId},on:{close:t.close,add:t.addToChart,selected:function(e){t.selection=e}}}):"community"===t.tab?e("CommunityIndicators",{key:"community",attrs:{"pane-id":t.paneId},on:{close:t.close,selected:function(e){t.selection=e}}}):t._e()],1),t.selection?e("IndicatorDetail",{attrs:{indicator:t.selection,"pane-id":t.paneId},on:{close:function(e){t.selection=null},add:function(e){return t.addToChart(e,!0)},reload:t.reloadSelection}}):t._e()],1)}),[],!1,null,"04757fb5",null,null).exports,J=Object.freeze(Object.defineProperty({__proto__:null,default:H},Symbol.toStringTag,{value:"Module"}));export{J as I,W as u};
